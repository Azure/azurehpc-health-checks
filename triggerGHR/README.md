# triggerGHR Script

The script “triggerGHR.sh” component is created to automate the process of triggering GHR through ImpactRP API by mentioning the failure scenarios based on the NHC test. 

## Prerequisite

1) If the user wants to use NHC and report failure to GHR, they must be onboarded to both Azure health check (NHC) and Azure Impact Reporting (GHR) services. 
2) If the user wants to use only Azure Impact Reporting (GHR) service, they must be onboarded to GHR (please refer link for more information https://review.learn.microsoft.com/en-us/azure/impact-reporting/onboardtoimpactrp?branch=main&tabs=powershell%2Cconnectivity) and have the impact reporter role assigned to either a user-assigned identity or system-assigned identity to report the Impact to GHR.  
3) If the resource that triggers this script has impact reporter role assigned to "user assigned identity" and not to "system assigned identity", then user must provide the "object_id" from Azure Portal that corresponds to the user assigned identity in the .env file. Otherwise, the resource will not be able to access GHR because of authentication failure. 
4) To run the script with the -r option and report to GHR, the user needs to meet the conditions (2,3) above and provide input for the variable FAILURE_SCENARIO in .env file.
5) If the user has some additional options like (-c, -o, -a) to trigger the NHC, then the user will have to provide this information in the variable "ADDITIONAL_OPTIONS_FOR_NHC" variable in the .env file in config folder. specifies failure according to the user. 
6) The version of NHC should be latest, greater than AzNHC is v0.2.9.

## Running the script

There are two options to run the script triggerGHR.sh: –s or –f or -r.

Option – s: This option asks the user to enter the path of the script file “run-health-checks.sh” The path will be the folder where azurehpc-health-checks is located. It executes NHC first and then calls the ImpactRP API(GHR) based on the errors in NHC integrating the two. 

Option – f: This option requires the user to input the path of the log file that has NHC errors. An example would be the "health.log" file. This file is created by default by NHC while running the health check and contains all the errors that NHC generated in case of failure. We can use this log file to verify if the errors require Impact reporting and then invoke ImpactRP API(GHR) with the collected information.

Option –r: This option allows the user to trigger GHR, with user defined failure scenario and failure description. The user must provide the details of the failure in the .env file for the variables FAILURE_SCENARIO and FAILURE_DETAILS, respectively. In this case, the FAILURE_SCENARIO is a mandatory input to trigger GHR. Along with this, the user defined failure scenario should map to one of the impact categories currently supported by the GHR.  

## Process flow of script

## Option -s example:  sudo ./triggerGHR.sh -s /opt/azurehpc/test/azurehpc-health-checks
This option can be used to run NHC first and then trigger the GHR based on the log file.

1) Provide the path of the NHC folder azurehpc-health-checks. 
2) Usage menu to run NHC will be displayed, the options is picked up as per user defined inputs from ADDITIONAL_OPTIONS_FOR_NHC, If no options are present the NHC is run with the default option.
3) NHC will run according to the options selected, if there is an error in NHC, it will be displayed on the screen and the same will be added to 
health.log file.
4) Then health.log file will be checked for fault codes/errors to determine if it needs to be reported to GHR. 
5) If yes, the impact category is mapped to fault codes and impact description will have the NHC error message. 
6) If the resource used by the user has access to GHR, then access token will be generated through managed identity to access Azure Impact Reporting. 
7) All the details of the VM is collected through Azure Instance Metadata Service (IMDS). 
8) Trigger the GHR with all the collected details. 

## Option -f example:  sudo ./triggerGHR.sh -f /opt/azurehpc/test/azurehpc-health-checks/health.log
This option can be used when NHC has already run and want to trigger the GHR based on the log file.

1) Provide the path of the Log file that has errors generated by NHC.
2) If the log file has fault codes/errors, then these checked to see if it needs to be reported to GHR.
3) If yes, the impact category is mapped to fault codes and impact description will have the NHC error message. 
4) If the resource used by the user has access to GHR, then generate the Auth token through managed identity to access Azure Impact Reporting. 
5) Collect all the relevant details of the VM through Azure Instance Metadata Service (IMDS). 
6) Trigger the GHR with all the collected details. 

## Option -r example:  sudo ./triggerGHR.sh -r
This option can be used when user wants to trigger GHR through this script, with their own failure scenario and failure description.

1) The user must provide the details of the failure in the .env file for the variables FAILURE_SCENARIO and FAILURE_DETAILS respectively. In this case, the FAILURE_SCENARIO is a mandatory input to trigger GHR.  
2) Depending on the provided FAILURE_SCENARIO, its respective fault_code/impact category is fetched by searching the nhc_fault_dictionary.cfg file. 
3) If the fault codes/impact category could not be mapped to the FAILURE_SCENARIO defined by the user, then error message is displayed as " The provided fault scenerio, is not supported by GHR ".
3) Else, the FAILURE_SCENARIO is mapped to fault codes/impact category and impact description will have the FAILURE_DETAILS defined by the user(if provided, else it will have the generic impact description). 
4) If the resource used by the user has access to GHR, then generate the Auth token through managed identity to access Azure Impact Reporting. 
5) Collect all the relevant details of the VM through Azure Instance Metadata Service (IMDS). 
6) Trigger the GHR with all the collected details. 

## Additional Information

- This script uses Azure Instance Metadata Service (IMDS) endpoints mentioned below for generating Access token and to collect Virtual Machine details. 
    - http://169.254.169.254/metadata/identity/oauth2/token  
    - http://169.254.169.254/metadata/instance/compute/
- Uri to onboard to NHC: https://github.com/Azure/azurehpc-health-checks/blob/main/README.md
- Uri to choose between system or user-assigned managed identities - https://learn.microsoft.com/en-us/entra/identity/managed-identities-azure-resources/managed-identity-best-practice-recommendations
- Uri to assign a managed identity access to a resource by using the Azure portal - https://learn.microsoft.com/en-us/entra/identity/managed-identities-azure-resources/howto-assign-access-portal
- If user is attempting to obtain tokens for user-assigned identities, you must include one of the optional properties(client_id , principal_id/object_id , msi_res_id). Otherwise the token service will attempt to obtain a token for a system-assigned identity, which may or may not exist.
    - Uri which has more information about the above said condition - https://learn.microsoft.com/en-us/azure/app-service/overview-managed-identity?tabs=portal%2Chttp#rest-endpoint-reference